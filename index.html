<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Palace Csocso Tracker</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
	<style>
		.vs {
			width: 10vw;
		}

		.stats {
			--bs-offcanvas-width: 85%;
		}

		.context {
			height: 80vh;
			width: 100%;
		}

		h1 {
			font-size: 20vh;
		}

		.emelt {
			height: 31vh;
			margin: 12px auto;
		}

		.also {
			min-width: 30vw;
		}

		.list-group {
			max-height: 60vh;
			overflow-y: scroll;
		}
	</style>
</head>

<body>
	<div id="app" class="container text-center">
		<div class="offcanvas offcanvas-end text-bg-dark" data-bs-backdrop="static" tabindex="-1" id="staticBackdrop"
			aria-labelledby="staticBackdropLabel">
			<div class="offcanvas-header">
				<h5 class="offcanvas-title" id="staticBackdropLabel">Add New Player</h5>
				<button type="button" class="btn-close bg-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<div class="container">
					<!-- Add New Nickname Input -->
					<div class="form-group row">
						<input type="text" id="new-nickname" class="form-control col" :value="newNickname"
							placeholder="Enter a new nickname" @input="addNewNickname" @keyup.enter="addNickname">
						<button class="btn btn-outline-success col-2" @click="addNickname" title="add">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
								class="bi bi-plus-square-fill" viewBox="0 0 16 16">
								<path
									d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0" />
							</svg>
						</button>
					</div>

					<!-- Display Players -->
					<div class="mt-3">
						<ul class="list-group">
							<li v-for="player in nicknames" class="list-group-item">{{ player }}</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="offcanvas offcanvas-end text-bg-dark stats" data-bs-backdrop="static" tabindex="-1" id="statsBackdrop"
			aria-labelledby="statsBackdropLabel">
			<div class="offcanvas-header">
				<h5 class="offcanvas-title" id="statsBackdropLabel">Stats</h5>
				<button type="button" class="btn-close bg-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<div class="container">
					<table class="table bg-white">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">RF</th>
								<th scope="col">RB</th>
								<th scope="col">RS</th>
								<th scope="col">BS</th>
								<th scope="col">BF</th>
								<th scope="col">BB</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(game, index) in games">
								<th scope="row">{{ index + 1 }}</th>
								<td>{{ game.red.front }}</td>
								<td>{{ game.red.back }}</td>
								<td>{{ game.red.score }}</td>
								<td>{{ game.blue.score }}</td>
								<td>{{ game.blue.front }}</td>
								<td>{{ game.blue.back }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="row context align-items-center flex-nowrap">
			<div class="row context align-items-center flex-nowrap">
				<div class="col teams">
					<div class="row" v-for="side in red">
						<div class="card text-danger">
							<div v-if="!gameOver" class="card-body" @click="increment(side.position, 'red')">
								<h3>{{ side.player }}</h3>
							</div>
							<div v-else class="card-body">
								<label for="red-select-{{side.position}}">{{ _.upperFirst(side.position) }}</label>
								<select class="form-control" id="red-select-{{side.position}}" v-model="game.red[side.position]">
									<option v-for="player in _.filter([game.red[side.position], ...suitablePlayers])">
										{{ player }}
									</option>
								</select>
							</div>
						</div>
					</div>
				</div>
				<div class="col bg-danger" v-if="!gameOver">
					<div class="card emelt">
						<div class="card-body align-conten-md-center">
							<h1>{{ game.red?.score}}</h1>
						</div>
					</div>
				</div>
				<div class="col bg-primary" v-if="!gameOver">
					<div class="card emelt">
						<div class="card-body align-conten-md-center">
							<h1>{{ game.blue?.score}}</h1>
						</div>
					</div>
				</div>
				<div v-else class="row justify-content-md-center vs">
					<div class="card">
						VS
					</div>
				</div>
				<div class="col teams">
					<div class="row" v-for="side in blue">
						<div class="card text-primary">
							<div v-if="!gameOver" class="card-body" @click="increment(side.position, 'blue')">
								<h3>{{ side.player }}</h3>
							</div>
							<div v-else class="card-body">
								<label for="blue-select-{{side.position}}">{{ _.upperFirst(side.position) }}</label>
								<select class="form-control" id="blue-select-{{side.position}}" v-model="game.blue[side.position]">
									<option v-for="player in _.filter([game.blue[side.position], ...suitablePlayers])" :key="player">
										{{ player }}
									</option>
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row justify-content-md-between">
			<div class="col-md-2">
				<div class="card">
					Timer
				</div>
			</div>
			<div class="col-md-4">
				<div class="card also">
					<div class="row-mt-4 flex-nowrap justify-content-end">
						<button class="btn btn-secondary col-2" data-bs-toggle="offcanvas" data-bs-target="#statsBackdrop"
							aria-controls="statsBackdrop">Stats</button>
						<button class="btn btn-primary col-4" data-bs-toggle="offcanvas" data-bs-target="#staticBackdrop"
							aria-controls="staticBackdrop">
							New player
						</button>
						<button v-if="gameOver" :disabled="isReady" class="btn btn-success col-5" @click="startGame">Start New
							Game</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
	<script>
		const defaultGame = {
			red: {
				score: 0,
				front: '',
				back: ''
			},
			blue: {
				score: 0,
				front: '',
				back: ''
			}
		}
		new Vue({
			el: '#app',
			data() {
				return {
					game: defaultGame,
					games: [],
					newNickname: '',
					nicknames: [],
					gameOver: true
				}
			},
			methods: {
				addNewNickname({ target: { value } }) {
					this.newNickname = value
				},
				addNickname() {
					if (!_.isEmpty(_.slice(this.newNickname).filter(r => !_.isEqual(r, ' ')).join('')) && !this.nicknames.includes(this.newNickname)) {
						this.nicknames.push(this.newNickname)
						this.newNickname = ''
					} else {
						alert('Nickname already exists or input is empty.')
					}
				},
				startGame() {
					this.gameOver = false
				},
				resetGame() {
					this.games.push(this.game)
					this.game = defaultGame
					this.gameOver = true
				},
				increment(position, side) {
					this.game[side].score++
					if (Object.values(this.game).some(p => p.score === 5)) {
						this.resetGame()
					}
				}
			},
			computed: {
				red: {
					get() {
						return _.compact(_.map(this.game.red, (player, position) => {
							if (_.isString(player)) {
								return { player, position }
							}
						}))
					},
				},
				blue: {
					get() {
						return _.compact(_.map(this.game.blue, (player, position) => {
							if (_.isString(player)) {
								return { player, position }
							}
						}))
					}
				},
				playersCount: {
					get() {
						return _.uniq(
							_.filter([
								this.game.red.front,
								this.game.red.back,
								this.game.blue.front,
								this.game.blue.back
							])
						)
					}
				},
				isReady: {
					get() {
						return this.playersCount.length < 4
					}
				},
				suitablePlayers: {
					get() {
						return _.filter(this.nicknames, n => !_.includes(this.playersCount, n))
					}
				},
			},
			mounted() {
				const gameState = localStorage.getItem('gameState');
				if (gameState) {
					this.game = JSON.parse(gameState)
				}
				const gamesState = localStorage.getItem('gamesState');
				if (gamesState) {
					this.games = JSON.parse(gamesState)
				}
				const nicknamesState = localStorage.getItem('nicknamesState');
				if (nicknamesState) {
					this.nicknames = JSON.parse(nicknamesState)
				}
				const gameOverdState = localStorage.getItem('gameOverState');
				if (gameOverdState) {
					this.gameOver = JSON.parse(gameOverdState)
				}
			},
			watch: {
				game: {
					handler() {
						localStorage.setItem('gameState', JSON.stringify(this.$data.game))
					},
					deep: true
				},
				games: {
					handler() {
						localStorage.setItem('gamesState', JSON.stringify(this.$data.games))
					},
					deep: true
				},
				nicknames: {
					handler() {
						localStorage.setItem('nicknamesState', JSON.stringify(this.$data.nicknames))
					},
					deep: true
				},
				gameOver: {
					handler() {
						localStorage.setItem('gameOverState', JSON.stringify(this.$data.gameOver))
					},
					deep: true
				},
			}
		})
	</script>
</body>

</html>